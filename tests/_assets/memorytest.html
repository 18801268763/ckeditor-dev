<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Memory usage test</title>
	<script src="../../ckeditor.js"></script>
	<style>
		.button {
			margin: 5px;
		}
		.editor {
			display: block;
		}
	</style>
</head>
<body>
<button id="create" class="button">Create editor</button>
<button id="create-destroy-many" class="button">Create and destroy editor 100 times</button>
<textarea id="editor" class="editor"></textarea>

<script>
	( function() {
		let button = document.querySelector( '#create' ),
			buttonMany = document.querySelector( '#create-destroy-many' ),
			promise = Promise.resolve();

		button.addEventListener( 'click', () => {
			promise = promise.then( editor => {
				button.innerText = editor ? 'Create editor' : 'Destroy editor';
				return editor ? destroyEditor(  editor ) : createEditor();
			} );
		} );

		buttonMany.addEventListener( 'click', () => {
			promise.then( editor => {
				if ( editor ) {
					promise = promise.then( destroyEditor );
				}
				for ( let i = 0; i < 100; i++ ) {
					promise = promise.then( createEditor ).then( destroyEditor );
				}
			} );
		} );

		function destroyEditor( editor ) {
			return new Promise( res => {
				editor.on( 'destroy', function() {
					res();
				} );
				editor.destroy();
				editor = null;
			} );
		}

		function createEditor() {
			return new Promise( res => {
				CKEDITOR.replace( 'editor', {
					on: {
						instanceReady: function() {
							let hash = window.location.hash;

							if ( hash === '#combo' ) {
								this.once( 'panelShow', function() {
									res( this );
								}, this );
								CKEDITOR.document.findOne( '#cke_' + this.ui.get( 'Styles' ).id ).findOne( 'a' ).$.onclick();
							} else if ( hash === '#colorbutton' ) {
								CKEDITOR.document.findOne( '#' + this.ui.get( 'TextColor' )._.id ).$.click();
								res( this );
							} else if ( hash.indexOf( '#dialog-' ) > -1 ) {
								hash = hash.replace( '#dialog-', '' );
								this.once( 'dialogShow', function( evt ) {
									evt.data.hide();
								} );
								this.once( 'dialogHide', function() {
									res( this );
								}, this );
								this.execCommand( hash );
							} else {
								res( this );
							}
						}
					}
				} );
			} );
		}
	} )();
</script>
</body>
</html>
